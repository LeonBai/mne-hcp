<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Computing ERFs from HCP &mdash; MNE-HCP 0.1.dev12 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.4/cosmo/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.dev12',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="MNE-HCP 0.1.dev12 documentation" href="../index.html" />

<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700' rel='stylesheet' type='text/css'>







  </head>
  <body role="document">





  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          MNE-HCP</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1.dev12</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../auto_examples/index.html">Examples</a></li>
                <li><a href="index.html">Tutorials</a></li>
                <li><a href="../python_reference.html">API</a></li>
                <li><a href="https://github.com/mne-tools/mne-hcp">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Computing ERFs from HCP</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/auto_tutorials/plot_reproduce_erf.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><ul>
<li><a class="reference internal" href="#">Computing ERFs from HCP</a></li>
</ul>

<form action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-12">
      
  <div class="section" id="computing-erfs-from-hcp">
<span id="tut-reproduce-erf"></span><span id="sphx-glr-auto-tutorials-plot-reproduce-erf-py"></span><h1>Computing ERFs from HCP<a class="headerlink" href="#computing-erfs-from-hcp" title="Permalink to this headline">Â¶</a></h1>
<p>In this tutorial we compare different ways of arriving at event related
fields (ERF) starting from different HCP outputs. We will first reprocess
the HCP dat from scratch, then read the preprocessed epochs, finally
read the ERF files. Subsequently we will compare these outputs.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Author: Denis A. Enegemann</span>
<span class="c1"># License: BSD 3 clause</span>

<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">op</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">import</span> <span class="nn">hcp</span>
<span class="kn">import</span> <span class="nn">hcp.preprocessing</span> <span class="kn">as</span> <span class="nn">preproc</span>

<span class="n">mne</span><span class="o">.</span><span class="n">set_log_level</span><span class="p">(</span><span class="s1">&#39;WARNING&#39;</span><span class="p">)</span>

<span class="c1"># we assume our data is inside its designated folder under $HOME</span>
<span class="n">storage_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
<span class="n">hcp_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hcp_path</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s1">&#39;mne-hcp-data&#39;</span><span class="p">,</span> <span class="s1">&#39;HCP&#39;</span><span class="p">),</span>
    <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;105923&#39;</span><span class="p">,</span>
    <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;task_working_memory&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We first reprocess the data from scratch</p>
<p>That is, almost from scratch. We&#8217;re relying on the ICA solutions and
data annotations.</p>
<p>In order to arrive at the final ERF we need to pool over two runs.
for each run we need to read the raw data, all annotations, apply
the reference sensor compensation, the ICA, bandpass filter, baseline
correction and decimation (downsampling)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># these values are looked up from the HCP manual</span>
<span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span>
<span class="n">decim</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">event_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">face</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">baseline</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># we first collect events</span>
<span class="n">trial_infos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">run_index</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
    <span class="n">hcp_params</span><span class="p">[</span><span class="s1">&#39;run_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_index</span>
    <span class="n">trial_info</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">read_trial_info</span><span class="p">(</span><span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>
    <span class="n">trial_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trial_info</span><span class="p">)</span>


<span class="c1"># trial_info is a dict</span>
<span class="c1"># it contains a &#39;comments&#39; vector that maps on the columns of &#39;codes&#39;</span>
<span class="c1"># &#39;codes is a matrix with its length corresponding to the number of trials</span>
<span class="k">print</span><span class="p">(</span><span class="n">trial_info</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="s1">&#39;comments&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">])</span>  <span class="c1"># which column?</span>
<span class="k">print</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">trial_info</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="s1">&#39;codes&#39;</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">]))</span>  <span class="c1"># check values</span>

<span class="c1"># so according to this we need to use the column 7 (index 6)</span>
<span class="c1"># for the time sample and column 4 (index 3) to get the image types</span>
<span class="c1"># with this information we can construct our event vectors</span>

<span class="n">all_events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">trial_info</span> <span class="ow">in</span> <span class="n">trial_infos</span><span class="p">:</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span>
        <span class="n">trial_info</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="s1">&#39;codes&#39;</span><span class="p">][:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># time sample</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trial_info</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="s1">&#39;codes&#39;</span><span class="p">])),</span>
        <span class="n">trial_info</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">][</span><span class="s1">&#39;codes&#39;</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># event codes</span>
    <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># for some reason in the HCP data the time events may not always be unique</span>
    <span class="n">unique_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">events</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">unique_subset</span><span class="p">]</span>  <span class="c1"># use diff to find first unique events</span>

    <span class="n">all_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

<span class="c1"># now we can go ahead</span>
<span class="n">evokeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">run_index</span><span class="p">,</span> <span class="n">events</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">all_events</span><span class="p">):</span>

    <span class="n">hcp_params</span><span class="p">[</span><span class="s1">&#39;run_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_index</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">read_raw</span><span class="p">(</span><span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
    <span class="c1"># apply ref channel correction and drop ref channels</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">apply_ref_correction</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

    <span class="n">annots</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">read_annot</span><span class="p">(</span><span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>
    <span class="c1"># construct MNE annotations</span>
    <span class="n">bad_seg</span> <span class="o">=</span> <span class="p">(</span><span class="n">annots</span><span class="p">[</span><span class="s1">&#39;segments&#39;</span><span class="p">][</span><span class="s1">&#39;all&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">]</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">Annotations</span><span class="p">(</span>
        <span class="n">bad_seg</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">bad_seg</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bad_seg</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;bad&#39;</span><span class="p">)</span>

    <span class="n">raw</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;bads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">annots</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="s1">&#39;all&#39;</span><span class="p">])</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">pick_types</span><span class="p">(</span><span class="n">meg</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ref_meg</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Note: MNE complains on Python 2.7</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;iir&#39;</span><span class="p">,</span>
               <span class="n">iir_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;iir&#39;</span><span class="p">,</span>
               <span class="n">iir_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># read ICA and remove EOG ECG</span>
    <span class="c1"># note that the HCP ICA assumes that bad channels have already been removed</span>
    <span class="n">ica_mat</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">read_ica</span><span class="p">(</span><span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>

    <span class="c1"># We will select the brain ICs only</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">annots</span><span class="p">[</span><span class="s1">&#39;ica&#39;</span><span class="p">][</span><span class="s1">&#39;total_ic_number&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
               <span class="k">if</span> <span class="n">ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annots</span><span class="p">[</span><span class="s1">&#39;ica&#39;</span><span class="p">][</span><span class="s1">&#39;brain_ic_vs&#39;</span><span class="p">]]</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">apply_ica_hcp</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">ica_mat</span><span class="o">=</span><span class="n">ica_mat</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>

    <span class="c1"># now we can epoch</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">Epochs</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span>
                        <span class="n">reject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span> <span class="n">decim</span><span class="o">=</span><span class="n">decim</span><span class="p">,</span>
                        <span class="n">preload</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>
    <span class="c1"># now we need to add back out channels for comparison across runs.</span>
    <span class="n">evoked</span> <span class="o">=</span> <span class="n">preproc</span><span class="o">.</span><span class="n">interpolate_missing</span><span class="p">(</span><span class="n">evoked</span><span class="p">,</span> <span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>
    <span class="n">evokeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evoked</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">raw</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-python"><div class="highlight"><pre><span></span>[u&#39;1. Run Number&#39; u&#39;2. Block Number within run&#39;
 u&#39;3. Nan.  ( This column has been reserved to contain the image ID number which is not encoded in the trigger values. This is not yet implemented.)&#39;
 u&#39;4. imgType : 1- Face, 2- Tools  0- Fixation&#39;
 u&#39;5. memoryType :  1: 0-Back   2: 2-Back&#39;
 u&#39;6. targetType : 1- target, 2- nontarget,  3: lure &#39;
 u&#39;7. Trial trigger onset Sample &#39; u&#39;8. Trial trigger offset Sample&#39;
 u&#39;9. Sequence of image in the block&#39;
 u&#39;10. isPressed :  0- user did not press any response button, 1- user pressed a response button&#39;]
set([0.0, 1.0, 2.0])
The default output type is &quot;ba&quot; in 0.13 but will change to &quot;sos&quot; in 0.14
The default output type is &quot;ba&quot; in 0.13 but will change to &quot;sos&quot; in 0.14
The default output type is &quot;ba&quot; in 0.13 but will change to &quot;sos&quot; in 0.14
The default output type is &quot;ba&quot; in 0.13 but will change to &quot;sos&quot; in 0.14
</pre></div>
</div>
<p>Now we can compute the same ERF based on the preprocessed epochs</p>
<p>These are obtained from the &#8216;tmegpreproc&#8217; pipeline.
Things are pythonized and simplified however, so</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">evokeds_from_epochs_hcp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">run_index</span><span class="p">,</span> <span class="n">events</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">all_events</span><span class="p">):</span>
    <span class="n">hcp_params</span><span class="p">[</span><span class="s1">&#39;run_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_index</span>

    <span class="n">epochs_hcp</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">read_epochs</span><span class="p">(</span><span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>
    <span class="c1"># for some reason in the HCP data the time events may not always be unique</span>
    <span class="n">unique_subset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">events</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">evoked</span> <span class="o">=</span> <span class="n">epochs_hcp</span><span class="p">[</span><span class="n">unique_subset</span><span class="p">][</span><span class="n">events</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">average</span><span class="p">()</span>

    <span class="k">del</span> <span class="n">epochs_hcp</span>
    <span class="c1"># These epochs have different channels.</span>
    <span class="c1"># We use a designated function to re-apply the channels and interpolate</span>
    <span class="c1"># them.</span>

    <span class="n">evoked</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span>
    <span class="n">evoked</span><span class="o">.</span><span class="n">apply_baseline</span><span class="p">()</span>
    <span class="n">evoked</span> <span class="o">=</span> <span class="n">preproc</span><span class="o">.</span><span class="n">interpolate_missing</span><span class="p">(</span><span class="n">evoked</span><span class="p">,</span> <span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>

    <span class="n">evokeds_from_epochs_hcp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evoked</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally we can read the actual official ERF file</p>
<p>These are obtained from the &#8216;eravg&#8217; pipelines.
We read the matlab file, MNE-HCP is doing some conversions, and then we
search our condition of interest. Here we&#8217;re looking at the image as onset.
and we want the average, not the standard deviation.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">evoked_hcp</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">del</span> <span class="n">hcp_params</span><span class="p">[</span><span class="s1">&#39;run_index&#39;</span><span class="p">]</span>
<span class="n">hcp_evokeds</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">read_evokeds</span><span class="p">(</span><span class="n">onset</span><span class="o">=</span><span class="s1">&#39;stim&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">hcp_evokeds</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ev</span><span class="o">.</span><span class="n">comment</span> <span class="o">==</span> <span class="s1">&#39;Wrkmem_LM-TIM-face_BT-diff_MODE-mag&#39;</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="c1"># Once more we add and interpolate missing channels</span>
<span class="n">evoked_hcp</span> <span class="o">=</span> <span class="n">preproc</span><span class="o">.</span><span class="n">interpolate_missing</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="o">**</span><span class="n">hcp_params</span><span class="p">)</span>
</pre></div>
</div>
<p>Time to compare the outputs</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">evoked</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">combine_evoked</span><span class="p">(</span><span class="n">evokeds</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">evoked_from_epochs_hcp</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">combine_evoked</span><span class="p">(</span>
    <span class="n">evokeds_from_epochs_hcp</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="n">fig1</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">evoked</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MNE-HCP&#39;</span><span class="p">)</span>

<span class="n">evoked_from_epochs_hcp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;HCP epochs&#39;</span><span class="p">)</span>

<span class="n">evoked_hcp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;HCP evoked&#39;</span><span class="p">)</span>
<span class="n">fig1</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># now some correlations</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">evoked_from_epochs_hcp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                 <span class="n">evoked_hcp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">evoked_from_epochs_hcp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[::</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e15</span><span class="p">,</span>
         <span class="n">evoked_hcp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[::</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e15</span><span class="p">,</span>
         <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
         <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;r=</span><span class="si">%0.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">r1</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">250</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;evoked from HCP epochs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;evoked from HCP evoked&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">evoked_hcp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[::</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e15</span><span class="p">,</span>
         <span class="n">evoked_hcp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[::</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e15</span><span class="p">,</span>
         <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
         <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;r=</span><span class="si">%0.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">r1</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">250</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;evoked from scratch with MNE-HCP&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;evoked from HCP evoked file&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><a class="first reference internal image-reference" href="../_images/sphx_glr_plot_reproduce_erf_001.png"><img alt="../_images/sphx_glr_plot_reproduce_erf_001.png" src="../_images/sphx_glr_plot_reproduce_erf_001.png" style="width: 564.0px; height: 376.0px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../_images/sphx_glr_plot_reproduce_erf_002.png"><img alt="../_images/sphx_glr_plot_reproduce_erf_002.png" src="../_images/sphx_glr_plot_reproduce_erf_002.png" style="width: 376.0px; height: 282.0px;" /></a>
</li>
<li><a class="first reference internal image-reference" href="../_images/sphx_glr_plot_reproduce_erf_003.png"><img alt="../_images/sphx_glr_plot_reproduce_erf_003.png" src="../_images/sphx_glr_plot_reproduce_erf_003.png" style="width: 376.0px; height: 282.0px;" /></a>
</li>
</ul>
<p><strong>Total running time of the script:</strong> ( 2 minutes  18.894 seconds)</p>
<div class="sphx-glr-download container">
<a class="reference download internal" href="../_downloads/plot_reproduce_erf.py"><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_reproduce_erf.py</span></code></a></div>
<div class="sphx-glr-download container">
<a class="reference download internal" href="../_downloads/plot_reproduce_erf.ipynb"><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_reproduce_erf.ipynb</span></code></a></div>
<p class="sphx-glr-signature"><a class="reference external" href="http://sphinx-gallery.readthedocs.io">Generated by Sphinx-Gallery</a></p>
</div>


    </div>
    
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Denis A. Engemann.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4a0+.<br/>
    </p>
  </div>
</footer>
  </body>
</html>