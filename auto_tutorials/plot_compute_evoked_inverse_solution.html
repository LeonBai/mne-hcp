<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Compute inverse solution for evoked data &mdash; MNE-HCP 0.1.dev12 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.4/cosmo/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.dev12',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="MNE-HCP 0.1.dev12 documentation" href="../index.html" />

<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700' rel='stylesheet' type='text/css'>

<!-- Github "fork me" ribbon -->
<!-- <a href="https://github.com/mne-tools/mne-hcp"><img style="position: absolute; top: 50px; right: 0; border: 0;"
src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67"
alt="Fork me on GitHub"
data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a> -->







  </head>
  <body role="document">





  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          MNE-HCP</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1.dev12</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../auto_examples/index.html">Examples</a></li>
                <li><a href="index.html">Tutorials</a></li>
                <li><a href="../python_reference.html">API</a></li>
                <li><a href="https://github.com/mne-tools/mne-hcp">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Compute inverse solution for evoked data</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/auto_tutorials/plot_compute_evoked_inverse_solution.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><ul>
<li><a class="reference internal" href="#">Compute inverse solution for evoked data</a></li>
</ul>

<form action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-12">
      
  <div class="section" id="compute-inverse-solution-for-evoked-data">
<span id="tut-compute-inverse-erf"></span><span id="sphx-glr-auto-tutorials-plot-compute-evoked-inverse-solution-py"></span><h1>Compute inverse solution for evoked data<a class="headerlink" href="#compute-inverse-solution-for-evoked-data" title="Permalink to this headline">Â¶</a></h1>
<p>Here we&#8217;ll use our knowledge from the other examples and tutorials
to compute an inverse solution and apply it on event related fields.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Author: Denis A. Enegemann</span>
<span class="c1"># License: BSD 3 clause</span>

<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">import</span> <span class="nn">hcp</span>
<span class="kn">from</span> <span class="nn">hcp</span> <span class="kn">import</span> <span class="n">preprocessing</span> <span class="k">as</span> <span class="n">preproc</span>
</pre></div>
</div>
<p>we assume our data is inside a designated folder under $HOME</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">storage_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/mne-hcp-data&#39;</span><span class="p">)</span>
<span class="n">hcp_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s1">&#39;HCP&#39;</span><span class="p">)</span>
<span class="n">recordings_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s1">&#39;hcp-meg&#39;</span><span class="p">)</span>
<span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s1">&#39;hcp-subjects&#39;</span><span class="p">)</span>
<span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;105923&#39;</span>  <span class="c1"># our test subject</span>
<span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;task_working_memory&#39;</span>
<span class="n">run_index</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>We&#8217;re reading the evoked data.
These are the same as in <a class="reference internal" href="../auto_examples/plot_evoked_data.html#tut-plot-evoked"><span>Visualize evoked data</span></a></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">hcp_evokeds</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">read_evokeds</span><span class="p">(</span><span class="n">onset</span><span class="o">=</span><span class="s1">&#39;stim&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                                   <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">hcp_path</span><span class="o">=</span><span class="n">hcp_path</span><span class="p">)</span>
<span class="k">for</span> <span class="n">evoked</span> <span class="ow">in</span> <span class="n">hcp_evokeds</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">evoked</span><span class="o">.</span><span class="n">comment</span> <span class="o">==</span> <span class="s1">&#39;Wrkmem_LM-TIM-face_BT-diff_MODE-mag&#39;</span><span class="p">:</span>
        <span class="k">continue</span>
</pre></div>
</div>
<p>We&#8217;ll now use a convenience function to get our forward and source models
instead of computing them by hand.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">src_outputs</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">anatomy</span><span class="o">.</span><span class="n">compute_forward_stack</span><span class="p">(</span>
    <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">subjects_dir</span><span class="o">=</span><span class="n">subjects_dir</span><span class="p">,</span>
    <span class="n">hcp_path</span><span class="o">=</span><span class="n">hcp_path</span><span class="p">,</span> <span class="n">recordings_path</span><span class="o">=</span><span class="n">recordings_path</span><span class="p">,</span>
    <span class="c1"># speed up computations here. Setting `add_dist` to True may improve the</span>
    <span class="c1"># accuracy.</span>
    <span class="n">src_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">add_dist</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">info_from</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">run_index</span><span class="o">=</span><span class="n">run_index</span><span class="p">))</span>

<span class="n">fwd</span> <span class="o">=</span> <span class="n">src_outputs</span><span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Now we can compute the noise covariance. For this purpose we will apply
the same filtering as was used for the computations of the ERF in the first
place. See also <a class="reference internal" href="plot_reproduce_erf.html#tut-reproduce-erf"><span>Computing ERFs from HCP</span></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">raw_noise</span> <span class="o">=</span> <span class="n">hcp</span><span class="o">.</span><span class="n">read_raw</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">hcp_path</span><span class="o">=</span><span class="n">hcp_path</span><span class="p">,</span>
                         <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;noise_empty_room&#39;</span><span class="p">)</span>
<span class="n">raw_noise</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="c1"># apply ref channel correction and drop ref channels</span>
<span class="n">preproc</span><span class="o">.</span><span class="n">apply_ref_correction</span><span class="p">(</span><span class="n">raw_noise</span><span class="p">)</span>

<span class="c1"># Note: MNE complains on Python 2.7</span>
<span class="n">raw_noise</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;iir&#39;</span><span class="p">,</span>
                 <span class="n">iir_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">raw_noise</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;iir&#39;</span><span class="p">,</span>
                 <span class="n">iir_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;butter&#39;</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-python"><div class="highlight"><pre><span></span>The default output type is &quot;ba&quot; in 0.13 but will change to &quot;sos&quot; in 0.14
The default output type is &quot;ba&quot; in 0.13 but will change to &quot;sos&quot; in 0.14
</pre></div>
</div>
<p>Note that using the empty room noise covariance will inflate the SNR of the
evkoked and renders comparisons  to <cite>baseline</cite> rather uninformative.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">noise_cov</span> <span class="o">=</span> <a href="http://martinos.org/mne/stable/generated/mne.compute_raw_covariance.html#mne.compute_raw_covariance"><span class="n">mne</span><span class="o">.</span><span class="n">compute_raw_covariance</span></a><span class="p">(</span><span class="n">raw_noise</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;empirical&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we assemble the inverse operator, project the data and show the results
on the <cite>fsaverage</cite> surface, the freesurfer average brain.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">inv_op</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">minimum_norm</span><span class="o">.</span><span class="n">make_inverse_operator</span><span class="p">(</span>
    <span class="n">evoked</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">fwd</span><span class="p">,</span> <span class="n">noise_cov</span><span class="o">=</span><span class="n">noise_cov</span><span class="p">)</span>

<span class="n">stc</span> <span class="o">=</span> <a href="http://martinos.org/mne/stable/generated/mne.minimum_norm.apply_inverse.html#mne.minimum_norm.apply_inverse"><span class="n">mne</span><span class="o">.</span><span class="n">minimum_norm</span><span class="o">.</span><span class="n">apply_inverse</span></a><span class="p">(</span>  <span class="c1"># these data have a pretty high SNR and</span>
    <span class="n">evoked</span><span class="p">,</span> <span class="n">inv_op</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;MNE&#39;</span><span class="p">,</span> <span class="n">lambda2</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mf">9.</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 9 is a lovely number.</span>

<span class="n">stc</span> <span class="o">=</span> <span class="n">stc</span><span class="o">.</span><span class="n">to_original_src</span><span class="p">(</span>
    <span class="n">src_outputs</span><span class="p">[</span><span class="s1">&#39;src_fsaverage&#39;</span><span class="p">],</span> <span class="n">subjects_dir</span><span class="o">=</span><span class="n">subjects_dir</span><span class="p">)</span>

<span class="n">brain</span> <span class="o">=</span> <span class="n">stc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">,</span> <span class="n">subjects_dir</span><span class="o">=</span><span class="n">subjects_dir</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">brain</span><span class="o">.</span><span class="n">set_time</span><span class="p">(</span><span class="mi">145</span><span class="p">)</span>  <span class="c1"># we take the peak seen in :ref:`tut_plot_evoked` and</span>
<span class="n">brain</span><span class="o">.</span><span class="n">show_view</span><span class="p">(</span><span class="s1">&#39;caudal&#39;</span><span class="p">)</span>  <span class="c1"># admire wide spread visual activation.</span>
</pre></div>
</div>
<img alt="../_images/sphx_glr_plot_compute_evoked_inverse_solution_001.png" class="align-center" src="../_images/sphx_glr_plot_compute_evoked_inverse_solution_001.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-python"><div class="highlight"><pre><span></span>Updating smoothing matrix, be patient..
Smoothing matrix creation, step 1
Smoothing matrix creation, step 2
Smoothing matrix creation, step 3
Smoothing matrix creation, step 4
Smoothing matrix creation, step 5
Smoothing matrix creation, step 6
Smoothing matrix creation, step 7
Smoothing matrix creation, step 8
Smoothing matrix creation, step 9
Smoothing matrix creation, step 10
colormap: fmin=2.35e-11 fmid=2.79e-11 fmax=9.14e-11 transparent=1
Updating smoothing matrix, be patient..
Smoothing matrix creation, step 1
Smoothing matrix creation, step 2
Smoothing matrix creation, step 3
Smoothing matrix creation, step 4
Smoothing matrix creation, step 5
Smoothing matrix creation, step 6
Smoothing matrix creation, step 7
Smoothing matrix creation, step 8
Smoothing matrix creation, step 9
Smoothing matrix creation, step 10
colormap: fmin=2.35e-11 fmid=2.79e-11 fmax=9.14e-11 transparent=1
</pre></div>
</div>
<p><strong>Total running time of the script:</strong> ( 1 minutes  33.565 seconds)</p>
<div class="sphx-glr-download container">
<a class="reference download internal" href="../_downloads/plot_compute_evoked_inverse_solution.py"><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_compute_evoked_inverse_solution.py</span></code></a></div>
<div class="sphx-glr-download container">
<a class="reference download internal" href="../_downloads/plot_compute_evoked_inverse_solution.ipynb"><code class="xref download docutils literal"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_compute_evoked_inverse_solution.ipynb</span></code></a></div>
<p class="sphx-glr-signature"><a class="reference external" href="http://sphinx-gallery.readthedocs.io">Generated by Sphinx-Gallery</a></p>
</div>


    </div>
    
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Denis A. Engemann.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4a0+.<br/>
    </p>
  </div>
</footer>
  </body>
</html>